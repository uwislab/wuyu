# name: Build and Deploy

 on:
   push:
     branches: [ "main", "group*" ]

 jobs:
   deploy:
     runs-on: ubuntu-latest
     steps:
       # Ê≠•È™§1ÔºöÊ£ÄÂá∫‰ª£Á†Å
       - name: Checkout Code
         uses: actions/checkout@v4

       # Ê≠•È™§2ÔºöÈÄöËøáSSHÊâßË°åÈÉ®ÁΩ≤Êìç‰Ωú
       - name: Execute Deployment Scripts
         uses: appleboy/ssh-action@v1
         with:
           host: ${{ secrets.SERVER_HOST }}
           username: ${{ secrets.SERVER_USER }}
           key: ${{ secrets.SERVER_SSH_KEY }}
           script: |
             set -e  # ‰ªª‰ΩïÂëΩ‰ª§Â§±Ë¥•Á´ãÂç≥ÁªàÊ≠¢ËÑöÊú¨
            
             # ÂàùÂßãÂåñÂèòÈáè
             BRANCH="${{ github.ref_name }}"
             REPO_DIR="/www/cicd_wuyu/wuyuProject/WuYuEducation"
             cd "$REPO_DIR"

             # ========== ‰ª£Á†ÅÂêåÊ≠•Èò∂ÊÆµ ==========
             echo "üîÑ Syncing $BRANCH branch..."
             git checkout -f $BRANCH
             git pull origin $BRANCH

             # ========== Á´ØÂè£ËÆ°ÁÆóÈò∂ÊÆµ ==========
             if [ "$BRANCH" = "main" ]; then
               GROUP_NUMBER=0
             else
               GROUP_NUMBER=$(echo "$BRANCH" | sed 's/group//')
             fi
             SERVER_PORT=$((9080 + GROUP_NUMBER))
             FRONTEND_PORT=$((9180 + GROUP_NUMBER))
             SERVER_IMAGE="wuyu-server-$BRANCH"
             FRONTEND_IMAGE="wuyu-front-$BRANCH"

             # ========== ÂêéÁ´ØÂ§ÑÁêÜÈò∂ÊÆµ ==========
             echo "üèóÔ∏è Building Backend..."
             cd wuyu-server
             docker build -t $SERVER_IMAGE . || { echo "‚ùå Backend build failed"; exit 1; }

             echo "üöÄ Deploying Backend..."
             docker stop $SERVER_IMAGE >/dev/null 2>&1 || true
             docker rm $SERVER_IMAGE >/dev/null 2>&1 || true
             docker run -d \
               --name $SERVER_IMAGE \
               -p $SERVER_PORT:8080 \
               $SERVER_IMAGE || { echo "‚ùå Backend deployment failed"; exit 1; }

             # ========== ÂâçÁ´ØÂ§ÑÁêÜÈò∂ÊÆµ ==========
             echo "üèóÔ∏è Building Frontend..."
             cd ../wuyu-front
             docker build -t $FRONTEND_IMAGE . || { echo "‚ùå Frontend build failed"; exit 1; }

             echo "üöÄ Deploying Frontend..."
             docker stop $FRONTEND_IMAGE >/dev/null 2>&1 || true
             docker rm $FRONTEND_IMAGE >/dev/null 2>&1 || true
             docker run -d \
               --name $FRONTEND_IMAGE \
               -p $FRONTEND_PORT:80 \
               $FRONTEND_IMAGE || { echo "‚ùå Frontend deployment failed"; exit 1; }

             # ========== ÂÆåÊàêÈò∂ÊÆµ ==========
             echo "‚úÖ Deployment completed for $BRANCH"
             echo "Backend: $SERVER_IMAGE @ port $SERVER_PORT"
             echo "Frontend: $FRONTEND_IMAGE @ port $FRONTEND_PORT"
