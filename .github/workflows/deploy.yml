name: Build and Deploy

on:
  push:
    branches: [ "main", "develop*" ]  # ‰øÆÊîπÂàÜÊîØÂåπÈÖçÊ®°Âºè

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Execute Deployment Scripts
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            set -e
            
            # ÂàùÂßãÂåñÂèòÈáèÔºà‰øÆÊîπÂàÜÊîØÂêçËß£ÊûêÈÄªËæëÔºâ
            BRANCH="${{ github.ref_name }}"
            REPO_DIR="/www/cicd_wuyu/wuyuProject/WuYuEducation"
            cd "$REPO_DIR"

            # ========== ‰ª£Á†ÅÂêåÊ≠•Èò∂ÊÆµ ==========
            echo "üîÑ Syncing $BRANCH branch..."
            git checkout -f $BRANCH
            git pull origin $BRANCH

            # ========== Á´ØÂè£ËÆ°ÁÆóÈò∂ÊÆµÔºàÂÖ≥ÈîÆ‰øÆÊîπÁÇπÔºâ ==========
            if [ "$BRANCH" = "main" ]; then
              GROUP_NUMBER=0
            else
              # ‰ªé develop-01 ‰∏≠ÊèêÂèñÊï∞Â≠óÈÉ®ÂàÜÔºàÂéªÊéâ "develop-" ÂíåÂâçÂØºÈõ∂Ôºâ
              GROUP_NUMBER=$(echo "$BRANCH" | sed 's/develop-//; s/^0*//')  # Á§∫‰æãÔºödevelop-01 ‚Üí 1
            fi
            SERVER_PORT=$((9080 + GROUP_NUMBER))  # ‰øùÊåÅÂéüÊúâÁ´ØÂè£ËÆ°ÁÆóÈÄªËæë
            FRONTEND_PORT=$((9180 + GROUP_NUMBER))
            SERVER_IMAGE="wuyu-server-$BRANCH"     # ÈïúÂÉèÂêçÂåÖÂê´ÂÆåÊï¥ÂàÜÊîØÂêç
            FRONTEND_IMAGE="wuyu-front-$BRANCH"

            # ========== ÂêéÁ´ØÂ§ÑÁêÜÈò∂ÊÆµ ==========
            echo "üèóÔ∏è Building Backend..."
            cd wuyu-server
            docker build -t $SERVER_IMAGE . || { echo "‚ùå Backend build failed"; exit 1; }

            echo "üöÄ Deploying Backend..."
            docker stop $SERVER_IMAGE >/dev/null 2>&1 || true
            docker rm $SERVER_IMAGE >/dev/null 2>&1 || true
            docker run -d \
              --name $SERVER_IMAGE \
              -p $SERVER_PORT:8080 \
              $SERVER_IMAGE || { echo "‚ùå Backend deployment failed"; exit 1; }

            # ========== ÂâçÁ´ØÂ§ÑÁêÜÈò∂ÊÆµ ========== 
            echo "üèóÔ∏è Building Frontend..."
            cd ../wuyu-front
            docker build -t $FRONTEND_IMAGE . || { echo "‚ùå Frontend build failed"; exit 1; }

            echo "üöÄ Deploying Frontend..."
            docker stop $FRONTEND_IMAGE >/dev/null 2>&1 || true
            docker rm $FRONTEND_IMAGE >/dev/null 2>&1 || true
            docker run -d \
              --name $FRONTEND_IMAGE \
              -p $FRONTEND_PORT:80 \
              $FRONTEND_IMAGE || { echo "‚ùå Frontend deployment failed"; exit 1; }

            # ========== ÂÆåÊàêÈò∂ÊÆµ ==========
            echo "‚úÖ Deployment completed for $BRANCH"
            echo "Backend: $SERVER_IMAGE @ port $SERVER_PORT"
            echo "Frontend: $FRONTEND_IMAGE @ port $FRONTEND_PORT"
