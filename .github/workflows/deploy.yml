# name: Build and Deploy

# on:
#   push:
#     branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Execute Deployment Scripts
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            set -e
            
            # ========== åˆå§‹åŒ–é…ç½® ==========
            echo "ğŸš€ Starting deployment process"
            BRANCH="main"
            REPO_DIR="/www/cicd_wuyu/wuyuProject/WuYuEducation/wuyu"
            
            # ä¿®å¤ Git å®‰å…¨ç›®å½•é—®é¢˜
            git config --global --add safe.directory "$REPO_DIR"
            
            cd "$REPO_DIR"
            
            # ========== ç«¯å£é…ç½® ==========
            SERVER_PORT=9080
            FRONTEND_PORT=9180
            FRONTEND_DIR="wuyu-front/dist"
            BACKEND_JAR_NAME="wuyu-server-main.jar"
            BACKEND_LOG="backend-main.log"
            
            # ========== ä»£ç åŒæ­¥ ==========
            echo "ğŸ”„ Syncing main branch..."
            git checkout -f $BRANCH
            git pull origin $BRANCH
            
            # ========== ç›®å½•éªŒè¯ ==========
            echo "ğŸ” Verifying project structure..."
            [ ! -d "wuyu-server" ] && { echo "âŒ wuyu-server directory missing"; exit 1; }
            [ ! -d "wuyu-front" ] && { echo "âŒ wuyu-front directory missing"; exit 1; }
            
            # ========== å‰ç«¯éƒ¨ç½² ==========
            echo "ğŸ“¦ Starting frontend deployment"
            
            # åœæ­¢å ç”¨å‰ç«¯ç«¯å£çš„è¿›ç¨‹
            echo "ğŸ›‘ Checking frontend port $FRONTEND_PORT..."
            FRONT_PID=$(lsof -t -i:$FRONTEND_PORT || true)
            if [ ! -z "$FRONT_PID" ]; then
              echo "â¹ï¸ Stopping frontend process (PID: $FRONT_PID)"
              kill -9 $FRONT_PID
              sleep 2
            fi
            
            # æ¸…ç†æ—§æ„å»ºæ–‡ä»¶
            echo "ğŸ§¹ Cleaning old frontend files..."
            cd wuyu-front
            rm -rf node_modules dist
            
            # å®‰è£…ä¾èµ–å¹¶æ„å»º
            echo "ğŸ”§ Installing dependencies..."
            npm install --silent
            
            echo "ğŸ—ï¸ Building frontend..."
            npm run build --silent
            echo "âœ… Frontend build completed"
            
            # éƒ¨ç½²å‰ç«¯
            echo "ğŸš€ Deploying frontend to port $FRONTEND_PORT..."
            nohup serve -s dist -l $FRONTEND_PORT > frontend.log 2>&1 &
            FRONT_PID=$!
            echo "ğŸ“ Frontend running on port $FRONTEND_PORT (PID: $FRONT_PID)"
            
            # ========== åç«¯éƒ¨ç½² ==========
            echo "ğŸ“¦ Starting backend deployment"
            cd ../wuyu-server
            
            # åœæ­¢å ç”¨åç«¯ç«¯å£çš„è¿›ç¨‹
            echo "ğŸ›‘ Checking backend port $SERVER_PORT..."
            BACK_PID=$(lsof -t -i:$SERVER_PORT || true)
            if [ ! -z "$BACK_PID" ]; then
              echo "â¹ï¸ Stopping backend process (PID: $BACK_PID)"
              kill -9 $BACK_PID
              sleep 3
            fi
            
            # æ¸…ç†æ—§æ„å»ºæ–‡ä»¶
            echo "ğŸ§¹ Cleaning old backend files..."
            rm -rf target $BACKEND_JAR_NAME
            
            # æ„å»ºåç«¯
            echo "ğŸ”§ Building backend..."
            mvn clean package -DskipTests -q
            mv target/*.jar $BACKEND_JAR_NAME
            echo "âœ… Backend build completed"
            
            # å¯åŠ¨åç«¯
            echo "ğŸš€ Starting backend on port $SERVER_PORT..."
            nohup java -jar $BACKEND_JAR_NAME --server.port=$SERVER_PORT > $BACKEND_LOG 2>&1 &
            BACK_PID=$!
            echo "ğŸ“ Backend running on port $SERVER_PORT (PID: $BACK_PID)"
            
            # ========== å¥åº·æ£€æŸ¥ ==========
            echo "ğŸ©º Performing health checks..."
            
            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            sleep 15
            
            # è¯Šæ–­åç«¯çŠ¶æ€
            echo "ğŸ” Diagnostic information:"
            echo "1. æ£€æŸ¥è¿›ç¨‹çŠ¶æ€:"
            ps -p $BACK_PID -o pid,user,cmd
            
            echo "2. æ£€æŸ¥ç«¯å£ç›‘å¬:"
            netstat -tuln | grep ":$SERVER_PORT" || true
            
            echo "3. åç«¯æ—¥å¿—æ‘˜è¦:"
            tail -20 $BACKEND_LOG
            
            # ä¿®æ”¹ç‚¹ï¼šç®€åŒ–å¥åº·æ£€æŸ¥ - åªéœ€æ£€æŸ¥è¿›ç¨‹æ˜¯å¦åœ¨è¿è¡Œ
            echo "4. ç®€åŒ–å¥åº·æ£€æŸ¥ - æ£€æµ‹è¿›ç¨‹æ˜¯å¦å­˜æ´»"
            if ps -p $BACK_PID > /dev/null; then
              echo "âœ… Backend health check passed - Process is running"
            else
              echo "âŒ Backend health check failed - Process not found"
              echo "===== FULL BACKEND LOG ====="
              cat $BACKEND_LOG
              exit 1
            fi
            
            # å‰ç«¯å¥åº·æ£€æŸ¥ä¿æŒä¸å˜
            if curl -f -s -o /dev/null "http://localhost:$FRONTEND_PORT"; then
              echo "âœ… Frontend health check passed"
            else
              echo "âŒ Frontend health check failed"
              echo "===== FRONTEND LOG ====="
              cat ../wuyu-front/frontend.log
              exit 1
            fi
            
            # ========== æ¸…ç†å·¥ä½œ ==========
            echo "ğŸ§¼ Cleaning source code..."
            cd ..
            rm -rf wuyu-front/node_modules wuyu-server/target
            
            echo "ğŸ‰ Deployment completed successfully!"
            echo "ğŸŒ Frontend: http://${{ secrets.SERVER_HOST }}:$FRONTEND_PORT"
            echo "âš™ï¸ Backend: http://${{ secrets.SERVER_HOST }}:$SERVER_PORT"
